<!DOCTYPE html>
<html>
<head>
  <script src="jspsych-6.1.0/jspsych.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
  <script src="taskSwitchingPlugins/ts-consent.js"></script>
  <script src="taskSwitchingPlugins/ts-trial.js"></script>
  <script src="taskSwitchingPlugins/ts-intro.js"></script>
  <script src="taskSwitchingPlugins/ts-trial-gap.js"></script>
  <script src="taskSwitchingPlugins/ts-info-card.js"></script>
  <script src="taskSwitchingPlugins/ts-block-break.js"></script>
  <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css">
  <link rel="stylesheet" href="taskSwitchingPlugins/css/ts-style.css">

  <!-- Defines the instructions trial (not plugin!) -->
  <script src="taskSwitchingPlugins/ts-instructions.js"></script>
  <script src="taskSwitchingPlugins/ts-ethics.js"></script>
  <title>Online Experiment</title>
</head>
<body tabindex="0" class=" jspsych-display-element" style="margin: 0px; height: 100vh; width: 100vw;">
<div class="jspsych-content-wrapper">
  <div id="jspsych-content" class="jspsych-content">
    <div>
      <h1>Loading</h1>
      <p>Please wait while we load the experiment. This should only take a few moments.</p>
      <p id="LoadingStatus" class="status">Checking JavaScript is enabled...</p>
    </div>
  </div>
</div>
</body>
<script defer type="text/javascript">
  const DEBUG = true;
  // Load the trial list from the Python script
  loadTrialList()
    .then(tl => createTimeline(tl))
    .then(timeline => begin(timeline));

  /**
   * Update status in the loading screen.
   */
  function message(s) {
    document.getElementById("LoadingStatus").innerHTML = s;
  }

  /**
   * Register an error in the loading screen and console.
   */
  function error(s, e) {
    message(s);
    console.error(e);
  }

  function loadTrialList() {
    message('Fetching experiment details from server...');
    return fetch('./handle-blueprints.php', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    })
            .then(r => r.json())
            .catch(e => error("Could not load experiment.", e));
  }

  /**
   * Create a jsPsych experiment timeline by adding participant details gathering stuff to the sequence defined in trialTypes
   * @param trials {object[]} Trial specifications
   * @return {object[]} jsPsych plugin trials
   */
  function createTimeline(json) {
    let out;
    try {
      jsPsych.data.addProperties({blueprintId: json.blueprint_id});
      const trials = JSON.parse(json.blueprint.trials);
      out = trials.map(t => parseTrial(t));
    } catch(e) {
      error("Error preparing experiment.", e);
    }
    return out;
  }

  function parseTrial(trial) {
    const t = {};
    const tt = trial["py/object"];
    if(/Component/.test(tt)) {
      if(/ComponentStart$/.test(tt)) {
        return {
          type: "ts-intro",
          trial_duration: trial.duration * 1000
        }
      } else if(/ComponentTrialGap$/.test(tt)) {
        return {
          type: "ts-trial-gap",
          trial_duration: trial.break_duration * 1000
        }
      } else if(/ComponentInfoCard$/.test(tt)) {
        return {
          type: "ts-info-card",
          trial_duration: trial.break_duration * 1000,
          next_task_type: trial.next_task
        }
      } else if(/ComponentRest$/.test(tt)) {
        const d = typeof trial.duration === "Object"?
                trial.duration["py/reduce"][1]["py/tuple"][0] : trial.duration;
        return {
          type: "ts-block-break",
          trial_duration: d * 1000
        }
      }
    } else if(/Trial/.test(tt)) {
      t.type = "ts-trial";
      t.max_response_time = trial.max_response_time * 1000;
      t.stimulus = trial.stimulus;
      t.stimulus_duration = trial.stimulus_duration * 1000;
      t.delay_before_response = trial.delay_before_response * 1000;
      t.answers = trial.answers;
      t.answer_index = trial.answer_index;

      if(/TrialDigitSpan$/.test(tt))
        return {trial_type: "ts-trial-digit-span", ...t};
      else if(/TrialSpatialSpan$/.test(tt))
        return {trial_type: "ts-trial-spatial-span", ...t};
      else if(/TrialSpatialRotation$/.test(tt))
        return {trial_type: "ts-trial-spatial-rotation", ...t};
    }
    throw `No matching type conditions found for trial type ${tt}`;
  }

  function begin(timeline) {
    if(DEBUG)
      timeline.shift();

    timeline = [ethics, consent, participant_info, instructions, ...timeline, end_thankyou];
    // Add data saving onto each of the timeline trials
    timeline.forEach(x => x.on_finish = saveLastTrialData);

    jsPsych.init({
      timeline: timeline
    });
  }


  function saveLastTrialData() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'write-data.php');
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onload = function() {
      if(xhr.status == 200){
        var response = JSON.parse(xhr.responseText);
        console.log(response.success);
      }
    };
    xhr.send(jsPsych.data.getLastTrialData().json());
    console.log('Saving data:');
    console.log(jsPsych.data.getLastTrialData().json());
  }

</script>
</html>